"use strict";!function(e,t){if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("object"==typeof exports&&module.exports)module.exports=e(require("leaflet"));else if(void 0!==t){if(void 0===t.L)throw"Leaflet must be loaded first!";e(t.L)}}(function(a){a.TileLayer.Offline=a.TileLayer.extend({initialize:function(e,t,i){this._url=e,this._tilesDb=t,(i=a.Util.setOptions(this,i)).detectRetina&&a.Browser.retina&&0<i.maxZoom&&(i.tileSize=Math.floor(i.tileSize/2),i.zoomReverse?(i.zoomOffset--,i.minZoom++):(i.zoomOffset++,i.maxZoom--),i.minZoom=Math.max(0,i.minZoom)),"string"==typeof i.subdomains&&(i.subdomains=i.subdomains.split("")),a.Browser.android||this.on("tileunload",this._onTileRemove)},createTile:function(e,t){var i=document.createElement("img");return a.DomEvent.on(i,"load",a.bind(this._tileOnLoad,this,t,i)),a.DomEvent.on(i,"error",a.bind(this._tileOnError,this,t,i)),this.options.crossOrigin&&(i.crossOrigin=""),i.alt="",i.setAttribute("role","presentation"),this.getTileUrl(e).then(function(e){i.src=e}).catch(function(e){throw e}),i},getTileUrl:function(e){var t=a.TileLayer.prototype.getTileUrl.call(this,e),e=this._getStorageKey(t);return this._tilesDb.getItem(e).then(function(e){return e&&"object"==typeof e?URL.createObjectURL(e):t}).catch(function(e){throw e})},getTileUrls:function(e,t){var i=[],o=this._url;this.setUrl(this._url.replace("{z}",t),!0);for(var n=a.bounds(e.min.divideBy(this.getTileSize().x).floor(),e.max.divideBy(this.getTileSize().x).floor()),r=n.min.x;r<=n.max.x;r++)for(var l=n.min.y;l<=n.max.y;l++){var s=new a.Point(r,l),s=a.TileLayer.prototype.getTileUrl.call(this,s);i.push({key:this._getStorageKey(s),url:s})}return this.setUrl(o,!0),i},_getStorageKey:function(e){var t,i=null;return e.indexOf("{s}")&&(t=new RegExp("["+this.options.subdomains.join("|")+"]."),i=e.replace(t,this.options.subdomains[0]+".")),i||e}}),a.tileLayer.offline=function(e,t,i){return new a.TileLayer.Offline(e,t,i)}},window),function(e,t){if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("object"==typeof exports&&module.exports)module.exports=e(require("leaflet"));else if(void 0!==t){if(void 0===t.L)throw"Leaflet must be loaded first!";e(t.L)}}(function(a){a.Control.Offline=a.Control.extend({options:{position:"topleft",saveButtonHtml:"S",saveButtonTitle:"Save tiles",removeButtonHtml:"R",removeButtonTitle:"Remove tiles",minZoom:0,maxZoom:19,confirmSavingCallback:null,confirmRemovalCallback:null},initialize:function(e,t,i){this._baseLayer=e,this._tilesDb=t,a.Util.setOptions(this,i)},onAdd:function(e){var t=a.DomUtil.create("div","leaflet-control-offline leaflet-bar");return this._createButton(this.options.saveButtonHtml,this.options.saveButtonTitle,"save-tiles-button",t,this._saveTiles),this._createButton(this.options.removeButtonHtml,this.options.removeButtonTitle,"remove-tiles-button",t,this._removeTiles),t},_createButton:function(e,t,i,o,n){o=a.DomUtil.create("a",i,o);return o.innerHTML=e,o.href="#",o.title=t,a.DomEvent.disableClickPropagation(o),a.DomEvent.on(o,"click",a.DomEvent.stop),a.DomEvent.on(o,"click",n,this),a.DomEvent.on(o,"click",this._refocusOnMap,this),o},_saveTiles:function(){var e,t=this,i=[],o=[],n=this._map.getZoom(),r=this._map.getBounds();if(n<this.options.minZoom)t._baseLayer.fire("offline:below-min-zoom-error");else{for(var l=n;l<=this.options.maxZoom;l++)i.push(l);for(var s=0;s<i.length;s++)e=a.bounds(this._map.project(r.getNorthWest(),i[s]),this._map.project(r.getSouthEast(),i[s])),o=o.concat(this._baseLayer.getTileUrls(e,i[s]));n=function(){t._baseLayer.fire("offline:save-start",{nTilesToSave:o.length}),t._tilesDb.saveTiles(o).then(function(){t._baseLayer.fire("offline:save-end")}).catch(function(e){t._baseLayer.fire("offline:save-error",{error:e})})};this.options.confirmSavingCallback?this.options.confirmSavingCallback(o.length,n):n()}},_removeTiles:function(){function e(){t._baseLayer.fire("offline:remove-start"),t._tilesDb.clear().then(function(){t._baseLayer.fire("offline:remove-end")}).catch(function(e){t._baseLayer.fire("offline:remove-error",{error:e})})}var t=this;t.options.confirmRemovalCallback?t.options.confirmRemovalCallback(e):e()}}),a.control.offline=function(e,t,i){return new a.Control.Offline(e,t,i)}},window),function(e){"function"==typeof define&&define.amd?define(["./TileLayer.Offline","./Control.Offline"],e):"object"==typeof exports&&module.exports&&(module.exports=(require("./TileLayer.Offline"),void require("./Control.Offline")))}(function(e,t){});